<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>体操スコアシート (男子)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
      /* 男子用テーマカラー */
      body { background-color: #f0f8ff; color: #37474f; }
      h1, h3, h4, .tabs button.active { color: #1565c0; }
      .input-section, .ranking-section { border-color: #90caf9; }
      th { background-color: #e3f2fd; }
      tbody tr:nth-child(even) { background-color: #f0f8ff; }
      .tabs button { border-color: #90caf9; background-color: #e3f2fd; }
      button, input[type="file"]::file-selector-button { background-color: #1976d2; }
      button:hover, input[type="file"]::file-selector-button:hover { background-color: #1565c0; }
      input[type="text"], input[type="number"], select { border-color: #90caf9; }
      .manual-table thead th { background-color: #e3f2fd; }
      .switch-gender-btn { background-color: #ec407a; } /* 女子用に切り替えボタンはピンク */
      .delete-btn { background-color: #e53935; } /* 削除ボタンは赤色 */
      .delete-btn:hover { background-color: #c62828; }
      .switch-gender-btn:hover { background-color: #d81b60; }
      footer { border-top-color: #90caf9; }

      /* ヘッダーコントロール */
      .header-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1em;
        margin-bottom: 1em;
      }

      /* Pull to Refresh インジケーター */
      #pull-to-refresh-indicator {
        position: fixed;
        top: -50px; /* 初期状態では画面外 */
        left: 0;
        right: 0;
        text-align: center;
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 16px;
        z-index: 9999;
        transition: top 0.3s;
      }

      /* スマホ表示用のレイアウト調整 */
      @media (max-width: 768px) {
        .main-container {
          display: flex;
          flex-direction: column;
        }
        #score-input-link-section {
          order: 1; /* 1番上に表示 */
        }
        .ranking-section {
          order: 2; /* 2番目に表示 */
        }
        #data-registration-section {
          order: 3; /* 3番目に表示 */
        }
        #rankingTypeSelect {
          font-size: 1.1em; /* ドロップダウンの文字を大きくする */
          padding: 0.2em;
        }
        .ranking-section table td:last-child,
        .ranking-section table th:last-child {
          text-align: right; /* 「操作」列を右寄せに */
        }
        .ranking-section table td:last-child {
          white-space: nowrap; /* 編集・削除ボタンが改行されないように */
        }
        .player-name-cell { line-height: 1.4; } /* 名前の行間を調整 */
      }
    </style>
</head>
<body>
<header>
    <div id="pull-to-refresh-indicator">↓ 更新</div>
    <h1 id="competitionName">体操スコアシート (男子)</h1>
    <div class="header-controls">
        <a href="/viewer" target="_blank">速報(女)</a>
        <a href="/viewer_men" target="_blank">速報(男)</a>
        <button type="button" class="switch-gender-btn" onclick="location.href='index.html'">女子用</button>
    </div>
</header>

    <div id="connectionStatus" style="display: none; padding: 0.5em 1em; background-color: #fffbe6; border: 1px solid #ffe58f; border-radius: 4px; margin-bottom: 1em;"></div>
    <div class="save-container" style="margin-bottom: 1em;">
        <button id="saveButton">スプレッドシートに保存</button>
        <span id="saveStatus" style="color: green; font-weight: bold;"></span>
    </div>
    <button type="button" id="printBtn">このページを印刷する</button>
    <div style="margin-top: 1em; padding: 1em; border: 1px solid #b8daff; background-color: #cce5ff; border-radius: 8px;">
        <label for="finalizeToggle">大会を終了する:</label>
        <input type="checkbox" id="finalizeToggle">
        <span id="finalizeStatus" style="font-weight: bold;">進行中</span>
    </div>
    <div class="main-container">
        <div id="score-input-link-section" class="input-section" style="text-align: center; padding: 1em;">
            <button style="padding: 1em 2em; font-size: 1.2em;" onclick="window.open('input_men.html', '_blank')">点数入力ページへ</button>
        </div>
        <div class="ranking-section">
            <div class="tabs" id="rankingClassTabs">
                <!-- JavaScriptで動的にタブが生成されます -->
            </div>
            <div class="ranking-controls" style="margin: 1em 0;">
                <label for="rankingTypeSelect">ランキング種別:</label>
                <select id="rankingTypeSelect"></select>
            </div>
            <div class="table-wrapper" id="rankingTableWrapper">
                <!-- JavaScriptで動的にコンテンツが生成されます -->
            </div>
        </div>
        <div id="data-registration-section" class="input-section">
            <h3>データ登録</h3>
            <div style="margin-bottom:1em;">
                <label>大会名: <input type="text" id="competitionNameInput" placeholder="例: ○○大会" style="width: 20em;"></label>
            </div>
            <hr style="margin: 1.5em 0;">
            <div class="csv-upload-area" style="margin-bottom:1em;">
                <label for="csvInput">CSVファイルから一括登録:</label>
                <input type="file" id="csvInput" accept=".csv">
                <button id="csvUploadBtn">CSV読み込み</button>
                <a href="https://docs.google.com/spreadsheets/d/1RAgLBqJYUshdsZyUUcdXrqhUSpwJ_hOq1vjwbEascHc/copy" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">
                    <button type="button">テンプレートを開く</button>
                </a>
                <button id="csvHelpBtn" type="button">CSVデータの作り方</button>
                <button id="manualBtn" type="button">アプリ説明書</button>
                <button id="operationGuideBtn" type="button">大会当日の注意点</button>
            </div>
            <hr style="margin: 1.5em 0;">
            <div id="addPlayerSection" style="margin-bottom:1em;">
                <label>選手を個別に追加:</label>
                <input type="text" id="newPlayerName" placeholder="選手名">
                <select id="newPlayerClass"><option value="初級">初級クラス</option><option value="中級">中級クラス</option><option value="上級">上級クラス</option></select>
                <input type="text" id="newPlayerGroup" placeholder="組 (例: 1組)">
                <button id="addPlayerBtn">選手を追加</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Created by KOU</p>
    </footer>

    <div id="print-container"></div>
    <!-- アプリ説明書モーダル -->
    <div id="manualModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeManualModal">&times;</span>
            <h2>アプリ説明書</h2>
            <h3>アプリの利用可能規模について</h3>
            <p>このアプリは、Render.comの無料プランで動作していることを前提として、以下の規模での利用を想定しています。</p>
            <h4>推奨される大会規模</h4>
            <ul>
                <li><strong>管理・審判員:</strong> 5名程度</li>
                <li><strong>出場選手数:</strong> 100名程度</li>
                <li><strong>保護者などの同時閲覧者数:</strong> 300名程度</li>
            </ul>
            <p>上記の規模であれば、無料プランの範囲内で安定した動作が見込めます。</p>
            <h4>より大きな大会での利用</h4>
            <p>
                選手数が500名、同時閲覧者数が500名を超えるような、より大規模な大会で利用する場合は、サーバーの性能がボトルネックになる可能性があります。
                その際は、サーバー（Render.com）を有料プランにアップグレードすることで、より安定した動作を確保できます。
            </p>
            <p>ご不明な点があれば、いつでも開発者にご相談ください。</p>
        </div>
    </div>

    <!-- 大会当日の注意点モーダル -->
    <div id="operationGuideModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeOperationGuideModal">&times;</span>
            <h2>大会当日の運営で気をつけること</h2>
            
            <h3>大会前日までの準備</h3>
            <ol>
                <li><strong>最終版の選手データ（CSV）を完成させる:</strong>
                    <ul>
                        <li>必ず「テンプレートを開く」ボタンから作成したシートを元に、男女それぞれの最終的な選手リストを作成してください。</li>
                        <li>クラス名や組の表記が、選手間で統一されているか（例：「1組」と「１組」のような全角/半角の違いがないか）を再度確認してください。</li>
                    </ul>
                </li>
                <li><strong>本番さながらのリハーサルを行う (最重要):</strong>
                    <ul>
                        <li>前日までに、完成したCSVデータを実際にアプリで読み込み、「スプレッドシートに保存」ボタンを押して、データが正しく反映されるか必ず確認してください。</li>
                        <li>大会名を実際のものに設定し、いくつかの点数をダミーで入力してみて、ランキングが正しく更新されるかも見ておくと万全です。</li>
                    </ul>
                </li>
                <li><strong>機材とネットワーク環境の確認:</strong>
                    <ul>
                        <li><strong>インターネット接続:</strong> 会場のWi-Fiが安定しているかを確認してください。不安定な場合は、スマートフォンのテザリングなど、代替の接続手段を準備しておくと安心です。</li>
                        <li><strong>電源の確保:</strong> 運営用のPCや、審判が使うスマートフォンの充電は満タンにしておきましょう。長丁場になる場合は、モバイルバッテリーや延長コードがあると非常に役立ちます。</li>
                    </ul>
                </li>
            </ol>

            <h3>大会当日の運営フロー</h3>
            <ol>
                <li><strong>【開始前】アプリの起動とデータ読み込み:</strong>
                    <p>運営用のPCで管理ページを開き、当日の「大会名」を入力後、「CSV読み込み」で選手データを読み込みます。<strong>この時点で一度、「スプレッドシートに保存」ボタンを押して</strong>、開始時点のデータを記録してください。</p>
                </li>
                <li><strong>【競技中】審判による点数入力:</strong>
                    <p>審判は「点数入力ページ」で担当のクラス・組を選び、点数を入力します。入力された点数はリアルタイムでランキングに反映されます。</p>
                </li>
                <li><strong>【運営中】管理者の役割:</strong>
                    <p>管理者は、1つのクラスや班の競技が終了した区切りなどで、<strong>定期的に「スプレッドシートに保存」ボタンを押す</strong>ことをお勧めします。これにより、進捗が記録され、万が一のトラブル時にも安心です。</p>
                </li>
            </ol>
        </div>
    </div>

    <!-- CSVヘルプモーダル -->
    <div id="csvHelpModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCsvHelpModal">&times;</span>
            <h2>CSVデータの作り方 (男子用)</h2>
            <p>「テンプレートを開く」ボタンから作成したスプレッドシートに、以下の形式で選手データを入力し、「CSV (カンマ区切り)」形式で保存・ダウンロードしてください。</p>
            <p><strong>注意:</strong> 1行目のA1セルに大会名を入力してください。選手データは2行目のヘッダー（項目名）以降を読み込みます。</p>
            <table class="manual-table">
                <thead>
                    <tr>
                        <th>A列 (クラス)</th><th>B列 (組)</th><th>C列 (空欄)</th><th>D列 (選手名)</th><th>E列 (床)</th><th>F列 (あん馬)</th><th>G列 (つり輪)</th><th>H列 (跳馬)</th><th>I列 (平行棒)</th><th>J列 (鉄棒)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>(大会名を入力)</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>初級</td><td>1</td><td></td><td>体操 太郎</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td>
                    </tr>
                    <tr>
                        <td>中級</td><td>2</td><td></td><td>日本 陸</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td>
                    </tr>
                </tbody>
            </table>
            <h4>ポイント</h4>
            <ul>
                <li><strong>1行目:</strong> A1セルに大会名を入力します。</li>
                <li><strong>2行目以降 (選手データ):</strong></li>
                <li style="margin-left: 20px;"><strong>A列 (クラス):</strong> 「初級」「中級」「上級」「育成」など、大会に合わせたクラス名を入力します。</li>
                <li style="margin-left: 20px;"><strong>B列 (組):</strong> 「1」「2」のように数字のみ入力します（半角推奨）。アプリ側で「組」が自動的に補完されます。</li>
                <li style="margin-left: 20px;"><strong>C列:</strong> この列は使いませんが、必ず空の列として存在させてください。</li>
                <li style="margin-left: 20px;"><strong>E列〜J列 (得点):</strong> 初期値として 0 を入力しておくと確実です。</li>
            </ul>
            <h4>ダウンロードと反映の方法</h4>
            <ol>
                <li>Googleスプレッドシートのメニューから「ファイル」→「ダウンロード」→「カンマ区切り形式 (.csv)」を選択します。</li>
                <li>お使いのPCにCSVファイルがダウンロードされます。</li>
                <li>この管理ページに戻り、「CSVファイルから一括登録」の「ファイルを選択」ボタンから、先ほどダウンロードしたCSVファイルを選びます。</li>
                <li>「CSV読み込み」ボタンを押すと、データがアプリに反映されます。</li>
            </ol>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- ドラッグ＆ドロップライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="app_men.js"></script>
    <script>
        // 自動保存機能の追加
        let autoSaveTimer = null;
        function scheduleAutoSave() {
            // グローバルに定義されたトグルスイッチの状態を確認
            const autoSaveToggle = document.getElementById('autoSaveToggle');
            if (!autoSaveToggle || !autoSaveToggle.checked) {
                return; // トグルがOFFなら何もしない
            }

            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                const saveButton = document.getElementById('saveButton');
                if (saveButton) saveButton.click();
            }, 3000); // 3秒後に保存
        }
    </script>
    <script>
        // Pull to Refresh 機能
        document.addEventListener('DOMContentLoaded', () => {
            const indicator = document.getElementById('pull-to-refresh-indicator');
            let startY = 0;
            let isPulling = false;
            const pullThreshold = 70; // 70px引っ張ったら更新

            document.body.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    startY = e.touches[0].pageY;
                    isPulling = true;
                }
            }, { passive: true });

            document.body.addEventListener('touchmove', (e) => {
                if (!isPulling) return;

                const currentY = e.touches[0].pageY;
                const diffY = currentY - startY;

                if (diffY > 0) { // 下に引っ張っている場合のみ
                    indicator.style.top = `${Math.min(diffY / 2 - 50, 10)}px`; // インジケーターを少しだけ表示
                }
            }, { passive: true });

            document.body.addEventListener('touchend', (e) => {
                if (!isPulling) return;
                isPulling = false;
                indicator.style.top = '-50px'; // インジケーターを隠す

                const endY = e.changedTouches[0].pageY;
                if (endY - startY > pullThreshold) {
                    window.location.reload();
                }
            });
        });
    </script>
</body>
</html>
