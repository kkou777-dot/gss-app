<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>体操スコアシート (女子)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
      /* 女子用テーマカラー */
      body { background-color: #fff8fa; color: #5d4037; }
      h1, h3, h4, .tabs button.active { color: #d81b60; }
      .input-section, .ranking-section { border-color: #f8bbd0; }
      th { background-color: #fce4ec; }
      tbody tr:nth-child(even) { background-color: #fff8fa; }
      .tabs button { border-color: #f8bbd0; background-color: #fce4ec; }
      button, input[type="file"]::file-selector-button { background-color: #ec407a; }
      button:hover, input[type="file"]::file-selector-button:hover { background-color: #d81b60; }
      input[type="text"], input[type="number"], select { border-color: #f8bbd0; }
      .manual-table thead th { background-color: #fce4ec; }
      .switch-gender-btn { background-color: #1976d2; } /* 男子用に切り替えボタンは青 */
      .delete-btn { background-color: #e53935; } /* 削除ボタンは赤色 */
      .delete-btn:hover { background-color: #c62828; }
      .switch-gender-btn:hover { background-color: #1565c0; }
      footer { border-top-color: #f8bbd0; }

      /* ヘッダーコントロール */
      .header-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1em;
        margin-bottom: 1em;
      }

      /* Pull to Refresh インジケーター */
      #pull-to-refresh-indicator {
        position: fixed;
        top: -50px; /* 初期状態では画面外 */
        left: 0;
        right: 0;
        text-align: center;
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 16px;
        z-index: 9999;
        transition: top 0.3s;
      }
    </style>
</head>
<body>
<header>
    <div id="pull-to-refresh-indicator">↓ 更新</div>
    <h1 id="competitionName">体操スコアシート (女子)</h1>
    <div class="header-controls">
        <a href="/viewer" target="_blank">速報(女)</a>
        <a href="/viewer_men" target="_blank">速報(男)</a>
        <button type="button" class="switch-gender-btn" onclick="location.href='index_men.html'">男子用</button>
    </div>
</header>

    <!-- サーバー接続状態の表示エリア -->
    <div id="connectionStatus" style="display: none; padding: 0.5em 1em; background-color: #fffbe6; border: 1px solid #ffe58f; border-radius: 4px; margin-bottom: 1em;"></div>
    <div class="save-container" style="margin-bottom: 1em;">
        <button id="saveButton">スプレッドシートに保存</button>
        <span id="saveStatus" style="color: green; font-weight: bold;"></span>
    </div>
    <button type="button" id="printBtn">このページを印刷する</button>
    <div style="margin-top: 1em; padding: 1em; border: 1px solid #f5c6cb; background-color: #f8d7da; border-radius: 8px;">
        <label for="finalizeToggle">大会を終了する:</label>
        <input type="checkbox" id="finalizeToggle">
        <span id="finalizeStatus" style="font-weight: bold;">進行中</span>
    </div>
    <div class="input-section">
        <h3>データ登録</h3>
        <div style="margin-bottom:1em;">
            <label>大会名: <input type="text" id="competitionNameInput" placeholder="例: ○○大会" style="width: 20em;"></label>
        </div>
        <hr style="margin: 1.5em 0;">
        <div class="csv-upload-area" style="margin-bottom:1em;">
            <label for="csvInput">CSVファイルから一括登録:</label>
            <input type="file" id="csvInput" accept=".csv">
            <button id="csvUploadBtn">CSV読み込み</button>
            <!-- テンプレート用ボタン -->
            <a href="https://docs.google.com/spreadsheets/d/1vYNfVoS_Ri53BkI0CLblogJ_CnD1dcaIYma7hcbNFQc/copy?usp=sharing&new=true&headers=true&names=%E5%90%8D%E5%89%8D,%E3%82%AF%E3%83%A9%E3%82%B9,%E7%B5%84,%E5%BA%8A,%E8%B7%B3%E9%A6%AC,%E6%AE%B5%E9%81%95%E3%81%84%E5%B9%B3%E8%A1%8C%E6%A3%92,%E5%B9%B3%E5%9D%87%E5%8F%B0" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">
                <button type="button">テンプレートを開く</button>
            </a>
            <button id="csvHelpBtn" type="button">CSVデータの作り方</button>
            <button id="manualBtn" type="button">アプリ説明書</button>
        </div>
        <hr style="margin: 1.5em 0;">
        <div id="addPlayerSection" style="margin-bottom:1em;">
            <label>選手を個別に追加:</label>
            <input type="text" id="newPlayerName" placeholder="選手名">
            <select id="newPlayerClass"><option value="初級">初級クラス</option><option value="中級">中級クラス</option><option value="上級">上級クラス</option></select>
            <input type="text" id="newPlayerGroup" placeholder="組 (例: 1組)">
            <button id="addPlayerBtn">選手を追加</button>
        </div>
    </div>
    <div class="input-section" style="text-align: center; padding: 1em;">
        <button style="padding: 1em 2em; font-size: 1.2em;" onclick="window.open('input.html', '_blank')">点数入力ページへ</button>
    </div>

    <div class="container">
        <!-- クラス別 総合得点ランキング -->
        <div class="ranking-section">
            <div class="tabs" id="totalRankTabs">
                <!-- JavaScriptで動的にタブが生成されます -->
            </div>
            <div class="table-wrapper" id="totalRankTableWrapper">
                <!-- JavaScriptで動的にコンテンツが生成されます -->
            </div>
        </div>

        <!-- 種目別ランキング -->
        <div class="ranking-section">
            <div class="tabs" id="eventRankTabs">
                <!-- JavaScriptで動的にタブが生成されます -->
            </div>
            <div class="table-wrapper" id="eventRankTableWrapper">
                <!-- JavaScriptで動的にコンテンツが生成されます -->
            </div>
        </div>
    </div>

    <!-- 印刷専用のコンテンツエリア -->
    <div id="print-container"></div>

    <footer>
        <p>&copy; 2025 Created by KOU</p>
    </footer>

    <!-- CSVヘルプモーダル -->
    <div id="csvHelpModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCsvHelpModal">&times;</span>
            <h2>CSVデータの作り方 (女子用)</h2>
            <p>「テンプレートを開く」ボタンから作成したスプレッドシートに、以下の形式で選手データを入力し、「CSV (カンマ区切り)」形式で保存・ダウンロードしてください。</p>
            <p><strong>注意:</strong> 1行目のA1セルに大会名を入力してください。選手データは2行目のヘッダー（項目名）以降を読み込みます。</p>

            <table class="manual-table">
                <thead>
                    <tr>
                        <th>A列 (クラス)</th><th>B列 (組)</th><th>C列 (空欄)</th><th>D列 (選手名)</th><th>E列 (床)</th><th>F列 (跳馬)</th><th>G列 (段違い)</th><th>H列 (平均台)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>(大会名を入力)</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>初級</td><td>1</td><td></td><td>体操 花子</td><td>0</td><td>0</td><td>0</td><td>0</td>
                    </tr>
                    <tr>
                        <td>中級</td><td>2</td><td></td><td>日本 桜</td><td>0</td><td>0</td><td>0</td><td>0</td>
                    </tr>
                </tbody>
            </table>
            <h4>ポイント</h4>
            <ul>
                <li><strong>1行目:</strong> A1セルに大会名を入力します。</li>
                <li><strong>2行目以降 (選手データ):</strong></li>
                <li style="margin-left: 20px;"><strong>A列 (クラス):</strong> 「初級」「中級」「上級」「育成」など、大会に合わせたクラス名を入力します。</li>
                <li style="margin-left: 20px;"><strong>B列 (組):</strong> 「1」「2」のように数字のみ入力します（半角推奨）。アプリ側で「組」が自動的に補完されます。</li>
                <li style="margin-left: 20px;"><strong>C列:</strong> この列は使いませんが、必ず空の列として存在させてください。</li>
                <li style="margin-left: 20px;"><strong>E列〜H列 (得点):</strong> 初期値として 0 を入力しておくと確実です。</li>
            </ul>
            <h4>ダウンロードと反映の方法</h4>
            <ol>
                <li>Googleスプレッドシートのメニューから「ファイル」→「ダウンロード」→「カンマ区切り形式 (.csv)」を選択します。</li>
                <li>お使いのPCにCSVファイルがダウンロードされます。</li>
                <li>この管理ページに戻り、「CSVファイルから一括登録」の「ファイルを選択」ボタンから、先ほどダウンロードしたCSVファイルを選びます。</li>
                <li>「CSV読み込み」ボタンを押すと、データがアプリに反映されます。</li>
            </ol>
        </div>
    </div>

    <!-- アプリ説明書モーダル -->
    <div id="manualModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeManualModal">&times;</span>
            <h2>アプリ説明書</h2>
            <h3>アプリの利用可能規模について</h3>
            <p>このアプリは、Render.comの無料プランで動作していることを前提として、以下の規模での利用を想定しています。</p>
            <h4>推奨される大会規模</h4>
            <ul>
                <li><strong>管理・審判員:</strong> 5名程度</li>
                <li><strong>出場選手数:</strong> 100名程度</li>
                <li><strong>保護者などの同時閲覧者数:</strong> 300名程度</li>
            </ul>
            <p>上記の規模であれば、無料プランの範囲内で安定した動作が見込めます。</p>
            <h4>より大きな大会での利用</h4>
            <p>
                選手数が500名、同時閲覧者数が500名を超えるような、より大規模な大会で利用する場合は、サーバーの性能がボトルネックになる可能性があります。
                その際は、サーバー（Render.com）を有料プランにアップグレードすることで、より安定した動作を確保できます。
            </p>
            <p>ご不明な点があれば、いつでも開発者にご相談ください。</p>
        </div>
    </div>

    <!-- サーバーと通信するためのライブラリを読み込み -->
    <!-- ローカルファイルとして開いても動作するように、CDNからライブラリを読み込みます -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- ドラッグ＆ドロップライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="app.js"></script>
    <script>
        // 自動保存機能の追加
        let autoSaveTimer = null;
        function scheduleAutoSave() {
            // グローバルに定義されたトグルスイッチの状態を確認
            const autoSaveToggle = document.getElementById('autoSaveToggle');
            if (!autoSaveToggle || !autoSaveToggle.checked) {
                return; // トグルがOFFなら何もしない
            }

            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                const saveButton = document.getElementById('saveButton');
                if (saveButton) saveButton.click();
            }, 3000); // 3秒後に保存
        }
    </script>
    <script>
        // Pull to Refresh 機能
        document.addEventListener('DOMContentLoaded', () => {
            const indicator = document.getElementById('pull-to-refresh-indicator');
            let startY = 0;
            let isPulling = false;
            const pullThreshold = 70; // 70px引っ張ったら更新

            document.body.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    startY = e.touches[0].pageY;
                    isPulling = true;
                }
            }, { passive: true });

            document.body.addEventListener('touchmove', (e) => {
                if (!isPulling) return;

                const currentY = e.touches[0].pageY;
                const diffY = currentY - startY;

                if (diffY > 0) { // 下に引っ張っている場合のみ
                    indicator.style.top = `${Math.min(diffY / 2 - 50, 10)}px`; // インジケーターを少しだけ表示
                }
            }, { passive: true });

            document.body.addEventListener('touchend', (e) => {
                if (!isPulling) return;
                isPulling = false;
                indicator.style.top = '-50px'; // インジケーターを隠す

                const endY = e.changedTouches[0].pageY;
                if (endY - startY > pullThreshold) {
                    window.location.reload();
                }
            });
        });
    </script>
</body>
</html>
